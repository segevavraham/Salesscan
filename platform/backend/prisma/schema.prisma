// Prisma Schema for Sales Coach AI Platform
// Database: PostgreSQL 15+

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// USER & TEAM MODELS
// ============================================================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          UserRole  @default(USER)

  // Team association
  teamId        String?
  team          Team?     @relation(fields: [teamId], references: [id])

  // Profile
  avatar        String?
  phone         String?
  timezone      String?   @default("UTC")

  // Relations
  meetings      Meeting[]
  analytics     UserAnalytics?

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLogin     DateTime?

  // Soft delete
  deletedAt     DateTime?

  @@index([email])
  @@index([teamId])
  @@index([role])
  @@map("users")
}

enum UserRole {
  USER
  TEAM_LEADER
  ADMIN
  SUPER_ADMIN
}

model Team {
  id          String   @id @default(uuid())
  name        String
  description String?

  // Relations
  members     User[]
  meetings    Meeting[]

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("teams")
}

// ============================================================================
// MEETING MODELS
// ============================================================================

model Meeting {
  id              String         @id @default(uuid())

  // Ownership
  userId          String
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId          String?
  team            Team?          @relation(fields: [teamId], references: [id])

  // Meeting details
  title           String
  clientName      String?
  clientEmail     String?
  meetingType     MeetingType
  stage           SalesStage     @default(WARMING_UP)

  // Timing
  startedAt       DateTime       @default(now())
  endedAt         DateTime?
  duration        Int?           // seconds

  // Recording & transcription
  recordingUrl    String?
  recordingSize   Int?           // bytes
  transcriptId    String?        @unique
  transcript      Transcript?

  // AI Analysis
  summary         Json?          // Full MeetingSummary object
  performanceScore Float?        // 0-10
  confidence      Float?         // 0-100 deal confidence
  winProbability  Float?         // 0-100
  sentiment       String?        // overall sentiment

  // Metrics
  talkRatio       Float?         // % salesperson talked
  questionsAsked  Int?
  buyingSignals   Int?
  objectionsRaised Int?

  // Relations
  actionItems     ActionItem[]
  insights        Insight[]
  coachingTips    CoachingTip[]

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([userId])
  @@index([teamId])
  @@index([startedAt])
  @@index([meetingType])
  @@index([stage])
  @@map("meetings")
}

enum MeetingType {
  DISCOVERY
  DEMO
  PRESENTATION
  NEGOTIATION
  CLOSING
  FOLLOW_UP
  CHECK_IN
  OTHER
}

enum SalesStage {
  WARMING_UP
  DISCOVERY
  QUALIFICATION
  PRESENTATION
  NEGOTIATION
  CLOSING
  WON
  LOST
}

// ============================================================================
// TRANSCRIPTION MODELS
// ============================================================================

model Transcript {
  id            String              @id @default(uuid())
  meetingId     String              @unique
  meeting       Meeting             @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Transcript data
  segments      TranscriptSegment[]
  fullText      String              @db.Text
  language      String              @default("en")

  // Processing status
  status        TranscriptStatus    @default(PROCESSING)
  processingTime Int?               // milliseconds

  // Timestamps
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([meetingId])
  @@index([status])
  @@map("transcripts")
}

enum TranscriptStatus {
  PROCESSING
  COMPLETED
  FAILED
}

model TranscriptSegment {
  id            String     @id @default(uuid())
  transcriptId  String
  transcript    Transcript @relation(fields: [transcriptId], references: [id], onDelete: Cascade)

  // Segment data
  speaker       Speaker
  text          String     @db.Text
  confidence    Float

  // Timing
  startTime     Float      // seconds from meeting start
  endTime       Float      // seconds from meeting start

  // Analysis
  sentiment     Sentiment?
  keywords      String[]
  entities      Json?      // Named entities (companies, people, etc.)

  // Timestamps
  createdAt     DateTime   @default(now())

  @@index([transcriptId])
  @@index([startTime])
  @@index([speaker])
  @@map("transcript_segments")
}

enum Speaker {
  SALESPERSON
  CLIENT
  UNKNOWN
}

enum Sentiment {
  VERY_POSITIVE
  POSITIVE
  NEUTRAL
  NEGATIVE
  VERY_NEGATIVE
}

// ============================================================================
// ACTION ITEMS & INSIGHTS
// ============================================================================

model ActionItem {
  id            String       @id @default(uuid())
  meetingId     String
  meeting       Meeting      @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Action details
  description   String       @db.Text
  assignedTo    String       // 'salesperson' | 'client' | 'team' | user email
  priority      Priority
  status        ActionStatus @default(PENDING)

  // Timing
  dueDate       DateTime?
  completedAt   DateTime?

  // Detection
  detectedAt    Float?       // timestamp in meeting (seconds)
  confidence    Float?       // 0-1

  // Timestamps
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([meetingId])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
  @@map("action_items")
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActionStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

model Insight {
  id            String      @id @default(uuid())
  meetingId     String
  meeting       Meeting     @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Insight details
  type          InsightType
  category      String
  title         String
  description   String      @db.Text
  impact        Impact
  confidence    Float       // 0-1

  // Context
  timestamp     Float?      // seconds in meeting
  relatedText   String?     @db.Text

  // Timestamps
  createdAt     DateTime    @default(now())

  @@index([meetingId])
  @@index([type])
  @@index([impact])
  @@map("insights")
}

enum InsightType {
  BUYING_SIGNAL
  OBJECTION
  QUESTION_QUALITY
  TALK_RATIO_WARNING
  SENTIMENT_SHIFT
  KEY_MOMENT
  COMPETITOR_MENTION
  PRICING_DISCUSSION
  DECISION_MAKER_IDENTIFIED
  TIMELINE_MENTIONED
}

enum Impact {
  POSITIVE
  NEGATIVE
  NEUTRAL
}

model CoachingTip {
  id            String   @id @default(uuid())
  meetingId     String
  meeting       Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Tip details
  title         String
  description   String   @db.Text
  category      String
  priority      Priority

  // Suggested actions
  suggestedPhrases String[]
  reasoning     String?  @db.Text

  // Context
  timestamp     Float    // seconds in meeting
  confidence    Float    // 0-1

  // User interaction
  wasShown      Boolean  @default(false)
  wasUseful     Boolean?

  // Timestamps
  createdAt     DateTime @default(now())

  @@index([meetingId])
  @@index([timestamp])
  @@map("coaching_tips")
}

// ============================================================================
// ANALYTICS MODELS
// ============================================================================

model UserAnalytics {
  id                  String    @id @default(uuid())
  userId              String    @unique
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Meeting stats
  totalMeetings       Int       @default(0)
  totalDuration       Int       @default(0) // minutes
  avgDuration         Float?

  // Performance
  avgScore            Float?
  avgConfidence       Float?
  winRate             Float?

  // Behavior patterns
  bestMeetingType     MeetingType?
  avgTalkRatio        Float?
  avgQuestionsAsked   Float?
  avgBuyingSignals    Float?

  // Trends
  improvementRate     Float?    // % improvement over time
  lastMonthMeetings   Int?
  lastMonthWinRate    Float?

  // Timestamps
  lastCalculated      DateTime  @updatedAt

  @@index([userId])
  @@map("user_analytics")
}

// ============================================================================
// SYSTEM MODELS
// ============================================================================

model RefreshToken {
  id            String   @id @default(uuid())
  userId        String
  token         String   @unique
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model AuditLog {
  id            String   @id @default(uuid())
  userId        String?
  action        String
  resource      String
  resourceId    String?
  details       Json?
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
